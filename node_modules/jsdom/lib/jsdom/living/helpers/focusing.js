"use strict";
const nodeType = require("../node-type.js");
const FocusEvent = require("../generated/FocusEvent.js");
const idlUtils = require("../generated/utils.js");
const { isDisabled } = require("./form-controls.js");
<<<<<<< HEAD
<<<<<<< HEAD
=======
const { firstChildWithLocalName } = require("./traversal");
const { createAnEvent } = require("./events");
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
=======
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e
const { HTML_NS } = require("./namespaces");

const focusableFormElements = new Set(["input", "select", "textarea", "button"]);

// https://html.spec.whatwg.org/multipage/interaction.html#focusable-area, but also some of
// https://html.spec.whatwg.org/multipage/interaction.html#focusing-steps: e.g., Documents are not actually focusable
// areas, but their viewports are, and the first step of the latter algorithm translates Documents to their viewports.
// And also https://html.spec.whatwg.org/multipage/interaction.html#specially-focusable!
exports.isFocusableAreaElement = elImpl => {
  if (!elImpl._ownerDocument._defaultView && !elImpl._defaultView) {
    return false;
  }

  if (elImpl._nodeType === nodeType.DOCUMENT_NODE) {
    return true;
  }

<<<<<<< HEAD
<<<<<<< HEAD
  if (!Number.isNaN(parseInt(elImpl.getAttribute("tabindex")))) {
=======
  if (!Number.isNaN(parseInt(elImpl.getAttributeNS(null, "tabindex")))) {
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
=======
  if (!Number.isNaN(parseInt(elImpl.getAttribute("tabindex")))) {
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e
    return true;
  }

  if (elImpl._namespaceURI === HTML_NS) {
    if (elImpl._localName === "iframe") {
      return true;
    }

<<<<<<< HEAD
<<<<<<< HEAD
    if (elImpl._localName === "a" && elImpl.hasAttribute("href")) {
=======
    if (elImpl._localName === "a" && elImpl.hasAttributeNS(null, "href")) {
      return true;
    }

    if (elImpl._localName === "summary" && elImpl.parentNode &&
        elImpl.parentNode._localName === "details" &&
        elImpl === firstChildWithLocalName(elImpl.parentNode, "summary")) {
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
=======
    if (elImpl._localName === "a" && elImpl.hasAttribute("href")) {
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e
      return true;
    }

    if (focusableFormElements.has(elImpl._localName) && !isDisabled(elImpl)) {
      if (elImpl._localName === "input" && elImpl.type === "hidden") {
        return false;
      }

      return true;
    }
  }

  return false;
};

// https://html.spec.whatwg.org/multipage/interaction.html#fire-a-focus-event plus the steps of
// https://html.spec.whatwg.org/multipage/interaction.html#focus-update-steps that adjust Documents to Windows
exports.fireFocusEventWithTargetAdjustment = (name, target, relatedTarget) => {
  if (target === null) {
    // E.g. firing blur with nothing previously focused.
    return;
  }

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e
  const event = FocusEvent.createImpl(
    [
      name,
      {
        bubbles: false,
        cancelable: false,
        relatedTarget,
        view: target._ownerDocument._defaultView,
        detail: 0
      }
    ],
    {
      isTrusted: true
    }
  );
<<<<<<< HEAD
=======
  const event = createAnEvent(name, FocusEvent, {
    composed: true,
    relatedTarget,
    view: target._ownerDocument._defaultView,
    detail: 0
  });
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
=======
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e

  if (target._defaultView) {
    target = idlUtils.implForWrapper(target._defaultView);
  }

<<<<<<< HEAD
<<<<<<< HEAD
  // _dispatch allows setting isTrusted
=======
>>>>>>> 782567c486993431d88a7d42ed2c18702ecdfd4f
=======
  // _dispatch allows setting isTrusted
>>>>>>> b9690f13ae0b02552662ffbd680e2069f9283c9e
  target._dispatch(event);
};
